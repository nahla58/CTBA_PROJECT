<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTBA Platform Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 0 24px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-menu {
            padding: 0 16px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: var(--radius);
            color: #cbd5e1;
            text-decoration: none;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .nav-item.active {
            background: var(--primary-color);
            color: white;
            font-weight: 500;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .nav-label {
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-footer {
            padding: 24px;
            margin-top: auto;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-size: 12px;
            color: #94a3b8;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 24px;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .page-title h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .page-title p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 10px 16px 10px 40px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            width: 280px;
            font-size: 14px;
            background-color: var(--card-bg);
        }

        .search-box i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: var(--radius);
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.total { background: #dbeafe; color: var(--primary-color); }
        .stat-icon.pending { background: #fef3c7; color: var(--warning-color); }
        .stat-icon.critical { background: #fee2e2; color: var(--danger-color); }
        .stat-icon.high { background: #ffedd5; color: #f97316; }
        .stat-icon.medium { background: #f0f9ff; color: #0ea5e9; }
        .stat-icon.low { background: #f0fdf4; color: var(--success-color); }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            margin-top: 8px;
        }

        .stat-change.positive { color: var(--success-color); }
        .stat-change.negative { color: var(--danger-color); }

        /* Main Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-color);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            justify-content: center;
        }

        /* CVE Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            vertical-align: middle;
        }

        tr:hover {
            background: #f8fafc;
        }

        .severity-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .severity-critical { background: #fee2e2; color: #dc2626; }
        .severity-high { background: #fed7aa; color: #ea580c; }
        .severity-medium { background: #bfdbfe; color: #2563eb; }
        .severity-low { background: #bbf7d0; color: #16a34a; }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pending { background: #fef3c7; color: #d97706; }
        .status-accepted { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #dc2626; }
        .status-deferred { background: #e0e7ff; color: #4338ca; }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }

        /* Quick Actions */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 20px;
        }

        .action-card {
            background: #f8fafc;
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
            cursor: pointer;
        }

        .action-card:hover {
            background: #f1f5f9;
            border-color: var(--primary-color);
        }

        .action-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 20px;
        }

        .action-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .action-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Filters Section */
        .filters-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filters-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        select, input {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Technology Badge */
        .tech-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin: 2px;
        }

        .tech-out-of-scope { background: #fee2e2; color: #dc2626; }
        .tech-priority { background: #fef3c7; color: #d97706; }
        .tech-normal { background: #d1fae5; color: #065f46; }

        /* Footer */
        .dashboard-footer {
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                width: 80px;
            }
            .sidebar .nav-label, .sidebar-footer, .logo-text {
                display: none;
            }
            .main-content {
                margin-left: 80px;
            }
            .search-box input {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .quick-actions-grid {
                grid-template-columns: 1fr;
            }
            .search-box input {
                width: 150px;
            }
            .user-profile .user-name {
                display: none;
            }
        }

        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .filters-grid {
                grid-template-columns: 1fr;
            }
            .search-box {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <!-- Logo TDS by Nomios -->
                    <img src="tds_by_nomios.png" alt="Tds_by_nomios" 
                         style="height: 32px; width: auto; border-radius: 4px;">
                    <span class="logo-text" style="margin-left: 12px;">CTBA Platform</span>
                </div>
            </div>
            
            <nav class="nav-menu">
                <a href="#" class="nav-item active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-label">Dashboard</span>
                </a>
                <a href="#" class="nav-item" onclick="loadCVEManagement()">
                    <i class="fas fa-bug"></i>
                    <span class="nav-label">CVE Management</span>
                </a>
                <a href="#" class="nav-item" onclick="loadBulletins()">
                    <i class="fas fa-file-alt"></i>
                    <span class="nav-label">Bulletins</span>
                </a>
                <a href="#" class="nav-item" onclick="loadAnalytics()">
                    <i class="fas fa-chart-bar"></i>
                    <span class="nav-label">Analytics</span>
                </a>
                <a href="#" class="nav-item" onclick="loadTechnologies()">
                    <i class="fas fa-server"></i>
                    <span class="nav-label">Technologies</span>
                </a>
                <a href="#" class="nav-item" onclick="loadSettings()">
                    <i class="fas fa-cog"></i>
                    <span class="nav-label">Settings</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div>CTBA Platform</div>
                <div>¬© 2026 TDS by Nomios. All rights reserved.</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
           <div class="top-bar">
    <div class="page-title">
        <div style="display: flex; align-items: center; gap: 16px;">
            <!-- Petit logo TDS by Nomios -->
            <img src="backend\static\tds_by_nomios.png" alt="tds_by_nomios" 
                 style="height: 24px; width: auto; opacity: 0.7; border-radius: 3px;">
            <div>
                <h1>üõ°Ô∏è CTBA Platform Dashboard</h1>
                <p>üìã CVEs ‚Ä¢ üîß Technologies ‚Ä¢ üìä Statistics ‚Ä¢ Powered by TDS Nomios</p>
            </div>
        </div>
    </div>
    <div class="user-actions">
        <!-- AJOUTEZ CE BOUTON EN PREMIER -->
        <button class="btn btn-primary" onclick="refreshLatestCVEs()" 
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-bolt"></i>
            Refresh Latest CVEs
        </button>
        
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="global-search" placeholder="Search CVEs, technologies...">
        </div>
        <button class="btn btn-secondary" onclick="refreshData()">
            <i class="fas fa-sync-alt"></i>
            Refresh
        </button>
        <div class="user-profile" onclick="toggleUserMenu()">
            <div class="avatar" id="user-avatar">TR</div>
            <div class="user-info">
                <div class="user-name" id="user-name">Tahar Remadi</div>
                <div class="user-role" id="user-role">VOC Lead</div>
            </div>
            <i class="fas fa-chevron-down"></i>
        </div>
    </div>
</div>

            <!-- Dashboard Content -->
            <div id="dashboard-content">
                <!-- Content will be dynamically loaded -->
                <div class="loading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîê Login to CTBA Platform</h3>
                <button class="btn btn-icon" onclick="closeModal('login-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div class="filter-group">
                        <label class="filter-label">Username</label>
                        <input type="text" id="login-username" placeholder="Enter username" value="admin">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Password</label>
                        <input type="password" id="login-password" placeholder="Enter password" value="adminpass">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('login-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="performLogin()">Login</button>
            </div>
        </div>
    </div>

    <div class="modal" id="cve-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="cve-modal-title">CVE Details</h3>
                <button class="btn btn-icon" onclick="closeModal('cve-detail-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="cve-detail-content">
                    <!-- CVE details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('cve-detail-modal')">Close</button>
            </div>
        </div>
    </div>

    <div class="modal" id="action-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="action-modal-title">Process CVE</h3>
                <button class="btn btn-icon" onclick="closeModal('action-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div class="filter-group">
                        <label class="filter-label">Action</label>
                            <select id="action-select">
                            <option value="ACCEPTED">Accept</option>
                            <option value="REJECTED">Reject</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Comments</label>
                        <textarea id="action-comments" rows="4" placeholder="Enter comments..."></textarea>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Priority</label>
                        <select id="action-priority">
                            <option value="NORMAL">Normal</option>
                            <option value="PRIORITY">Priority</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('action-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitAction()">Submit</button>
            </div>
        </div>
    </div>

    <div class="modal" id="add-tech-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Technology/Product</h3>
                <button class="btn btn-icon" onclick="closeModal('add-tech-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div class="filter-group">
                        <label class="filter-label">Vendor</label>
                        <input type="text" id="tech-vendor" placeholder="e.g., Microsoft, Apache">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Product</label>
                        <input type="text" id="tech-product" placeholder="e.g., Windows, HTTP Server">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="tech-status">
                            <option value="NORMAL">Normal (in scope)</option>
                            <option value="PRIORITY">Priority (high attention)</option>
                            <option value="OUT_OF_SCOPE">Out of Scope (blacklist)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Reason (optional)</label>
                        <textarea id="tech-reason" rows="3" placeholder="Why is this technology being added?"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-tech-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitTechnology()">Add Technology</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000';
        let currentUser = null;
        let currentCVEId = null;
        let currentFilters = {
            status: 'PENDING',
            severity: '',
            vendor: '',
            product: '',
            limit: 50,
            offset: 0
        };

        // Authentication
        async function checkAuth() {
            const token = localStorage.getItem('ctba_token');
            const userJson = localStorage.getItem('ctba_user');

            // If we have a stored token and user, trust it for viewing the dashboard.
            if (token && userJson) {
                try {
                    currentUser = JSON.parse(userJson);
                    updateUserDisplay();
                    return true;
                } catch (e) {
                    // fall through to server verification
                }
            }

            // If no token, require login
            if (!token) {
                showLoginModal();
                return false;
            }

            // Try server-side verification if available, but don't block dashboard viewing on failure.
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/verify`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    // Expect server to return user info
                    const user = await response.json();
                    currentUser = user;
                    localStorage.setItem('ctba_user', JSON.stringify(user));
                    updateUserDisplay();
                    return true;
                }
            } catch (error) {
                // endpoint may not exist or network error; allow viewing but actions will still require a valid token
                console.warn('Auth verify failed or missing:', error);
            }

            // Fallback: we have a token but couldn't verify ‚Äî allow read-only viewing.
            try {
                currentUser = userJson ? JSON.parse(userJson) : { username: 'unknown', role: 'VIEWER' };
                updateUserDisplay();
                return true;
            } catch (e) {
                showLoginModal();
                return false;
            }
        }

        function showLoginModal() {
            document.getElementById('login-modal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function performLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('ctba_token', data.access_token);
                    localStorage.setItem('ctba_user', JSON.stringify({
                        username: data.username,
                        role: data.role
                    }));
                    
                    currentUser = {
                        username: data.username,
                        role: data.role
                    };
                    
                    updateUserDisplay();
                    closeModal('login-modal');
                    loadDashboard();
                    
                    showNotification('success', 'Login successful!');
                } else {
                    throw new Error('Login failed');
                }
            } catch (error) {
                showNotification('error', 'Login failed. Please check credentials.');
            }
        }

        function updateUserDisplay() {
            if (currentUser) {
                document.getElementById('user-name').textContent = currentUser.username;
                document.getElementById('user-role').textContent = currentUser.role;
                document.getElementById('user-avatar').textContent = 
                    currentUser.username.substring(0, 2).toUpperCase();
            }
        }

        // Dashboard Loading
        async function loadDashboard() {
            if (!await checkAuth()) return;
            
            document.getElementById('dashboard-content').innerHTML = `
                <!-- Filters Section -->
                <div class="filters-section">
                    <div class="filters-header">
                        <div class="filters-title">Filters</div>
                        <button class="btn btn-secondary btn-small" onclick="clearFilters()">
                            <i class="fas fa-times"></i>
                            Clear All
                        </button>
                    </div>
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Status</label>
                            <select id="filter-status" onchange="applyFilters()">
                                <option value="">All Status</option>
                                <option value="PENDING" selected>Pending</option>
                                <option value="ACCEPTED">Accepted</option>
                                <option value="REJECTED">Rejected</option>
                                <option value="DEFERRED">Deferred</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Severity</label>
                            <select id="filter-severity" onchange="applyFilters()">
                                <option value="">All Severities</option>
                                <option value="CRITICAL">Critical</option>
                                <option value="HIGH">High</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="LOW">Low</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Vendor</label>
                            <input type="text" id="filter-vendor" placeholder="Filter vendor..." oninput="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Product</label>
                            <input type="text" id="filter-product" placeholder="Filter product..." oninput="applyFilters()">
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="total-cves">0</div>
                                <div class="stat-label">Total CVEs</div>
                            </div>
                            <div class="stat-icon total">
                                <i class="fas fa-database"></i>
                            </div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>Loading...</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="pending-cves">0</div>
                                <div class="stat-label">Pending</div>
                            </div>
                            <div class="stat-icon pending">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="stat-change negative">
                            <i class="fas fa-arrow-up"></i>
                            <span>Loading...</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="critical-cves">0</div>
                                <div class="stat-label">Critical</div>
                            </div>
                            <div class="stat-icon critical">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="stat-change positive">
                            <i class="fas fa-minus"></i>
                            <span>Loading...</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="high-cves">0</div>
                                <div class="stat-label">High</div>
                            </div>
                            <div class="stat-icon high">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                        </div>
                        <div class="stat-change negative">
                            <i class="fas fa-arrow-up"></i>
                            <span>Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Grid -->
                <div class="dashboard-grid">
                    <!-- Main Table -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Recent CVEs</div>
                           <div class="card-actions">
    <button class="btn btn-secondary btn-icon" onclick="exportCVEs()">
        <i class="fas fa-download"></i>
    </button>
    <!-- AJOUTEZ CE BOUTON -->
    <button class="btn btn-primary" onclick="refreshLatestCVEs()">
        <i class="fas fa-bolt"></i>
        Get Latest CVEs
    </button>
</div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>CVE ID</th>
                                        <th>SOURCE</th>
                                        <th>SEVERITY</th>
                                        <th>SCORE</th>
                                        <th>AFFECTED PRODUCTS</th>
                                        <th>STATUS</th>
                                        <th>PUBLISHED</th>
                                        <th>UPDATED</th>
                                        <th>ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody id="cve-table-body">
                                    <tr><td colspan="9" class="loading"><div class="loading-spinner"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div style="padding: 16px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <div id="pagination-info">Loading...</div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary btn-small" id="prev-btn" onclick="prevPage()" disabled>
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                <button class="btn btn-secondary btn-small" id="next-btn" onclick="nextPage()" disabled>
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions & Info -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Quick Actions</div>
                        </div>
                        <div class="quick-actions-grid">
                            <div class="action-card" onclick="quickAction('review')">
                                <div class="action-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <div class="action-title">Review CVEs</div>
                                <div class="action-desc" id="review-count">Loading...</div>
                            </div>
                            <div class="action-card" onclick="quickAction('generate')">
                                <div class="action-icon">
                                    <i class="fas fa-file-export"></i>
                                </div>
                                <div class="action-title">Generate Bulletin</div>
                                <div class="action-desc">Create new bulletin</div>
                            </div>
                            <div class="action-card" onclick="quickAction('blacklist')">
                                <div class="action-icon">
                                    <i class="fas fa-ban"></i>
                                </div>
                                <div class="action-title">Update Blacklist</div>
                                <div class="action-desc">Manage technologies</div>
                            </div>
                            <div class="action-card" onclick="quickAction('analytics')">
                                <div class="action-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="action-title">View Analytics</div>
                                <div class="action-desc">Performance dashboard</div>
                            </div>
                        </div>

                        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <div class="card-title" style="margin-bottom: 16px;">System Status</div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>NVD Sync</span>
                                    <span class="status-badge status-accepted" id="nvd-sync-status">Checking...</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Email Service</span>
                                    <span class="status-badge status-accepted">Ready</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Last Import</span>
                                    <span id="last-import">Loading...</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Next Reminder</span>
                                    <span id="next-reminder">17/01/2026</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="dashboard-footer">
                    <div id="footer-info">
                        Loading CVEs...
                    </div>
                    <div>
                        Last updated: <strong id="last-updated">Loading...</strong>
                    </div>
                </div>
            `;
            
            // Load initial data
            loadStats();
            loadCVEs();
        }

        // Data Loading Functions
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/stats`);
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        const stats = data.summary;
                        document.getElementById('total-cves').textContent = stats.total_cves;
                        document.getElementById('pending-cves').textContent = stats.pending_cves;
                        document.getElementById('critical-cves').textContent = stats.cves_by_severity.CRITICAL || 0;
                        document.getElementById('high-cves').textContent = stats.cves_by_severity.HIGH || 0;
                        document.getElementById('review-count').textContent = `${stats.pending_cves} pending review`;
                        
                        // Update status indicators
                        document.getElementById('nvd-sync-status').textContent = 'Active';
                        document.getElementById('last-import').textContent = new Date().toLocaleString();
                    }
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadCVEs() {
            try {
                const params = new URLSearchParams();
                if (currentFilters.status) params.append('status', currentFilters.status);
                if (currentFilters.severity) params.append('severity', currentFilters.severity);
                if (currentFilters.vendor) params.append('vendor', currentFilters.vendor);
                if (currentFilters.product) params.append('product', currentFilters.product);
                params.append('limit', currentFilters.limit);
                params.append('offset', currentFilters.offset);
                
                const response = await fetch(`${API_BASE_URL}/api/cves?${params}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        renderCVETable(data.cves);
                        updatePagination(data.pagination);
                        updateFooter(data.pagination.total);
                    }
                }
            } catch (error) {
                console.error('Error loading CVEs:', error);
                document.getElementById('cve-table-body').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--danger-color);">
                            <i class="fas fa-exclamation-triangle"></i> Failed to load CVEs
                        </td>
                    </tr>
                `;
            }
        }

        function renderCVETable(cves) {
            const tbody = document.getElementById('cve-table-body');
            
            if (!cves || cves.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-inbox"></i> No CVEs found
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            cves.forEach(cve => {
                const severityClass = `severity-${cve.severity.toLowerCase()}`;
                const statusClass = `status-${cve.status.toLowerCase()}`;
                
                // Format products
                let productsHtml = '';
                    if (cve.affected_products && cve.affected_products.length > 0) {
                        cve.affected_products.forEach(p => {
                        let techBadge = '';
                        if (p.tech_status) {
                            const techClass = `tech-${p.tech_status.toLowerCase().replace('_', '-')}`;
                            techBadge = `<span class="tech-badge ${techClass}">${p.tech_status}</span>`;
                        }
                        // Make product entries clickable to manage technology status
                        const safeVendor = (p.vendor || '').replace(/'/g, "\\'");
                        const safeProduct = (p.product || '').replace(/'/g, "\\'");
                        productsHtml += `
                            <div style="margin-bottom: 4px; cursor: pointer;" onclick="openProductModal('${safeVendor}','${safeProduct}')">
                                <strong>${p.vendor}</strong>: ${p.product}
                                ${techBadge}
                            </div>
                        `;
                    });
                }
                
                // Format date
                const publishedDate = cve.published_date_formatted || cve.published_date || 'N/A';
                const updatedDate = cve.last_modified_date_formatted || cve.last_modified_date || 'N/A';
                const source = cve.source || 'N/A';
                
                html += `
                    <tr>
                        <td>
                            <div style="font-weight: 600; cursor: pointer; color: var(--primary-color);" 
                                 onclick="showCVEDetail('${cve.cve_id}')">
                                ${cve.cve_id}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                                ${cve.short_description || ''}
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: 500;">${source}</div>
                        </td>
                        <td>
                            <span class="severity-badge ${severityClass}">
                                ${cve.severity}
                            </span>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: ${cve.cvss_score && cve.cvss_score >= 9.0 ? '#dc2626' : cve.cvss_score >= 7.0 ? '#ea580c' : cve.cvss_score >= 4.0 ? '#ca8a04' : '#16a34a'};">
                                ${cve.cvss_score && cve.cvss_score > 0 ? cve.cvss_score : 'N/A'}
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                ${cve.cvss_version && cve.cvss_version !== 'N/A' ? `CVSS v${cve.cvss_version}` : ''}
                            </div>
                        </td>
                        <td style="min-width: 200px;">
                            ${productsHtml || 'Unknown'}
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${cve.status}
                            </span>
                        </td>
                        <td>
                           <div>${formatLocalDate(publishedDate)}</div>
<div style="font-size: 12px; color: var(--text-secondary);">
    ${calculateDaysAgo(publishedDate)}
</div>
                        </td>
                        <td>
                           <div>${formatLocalDate(updatedDate)}</div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-small" onclick="showCVEDetail('${cve.cve_id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${cve.status === 'PENDING' ? `
                                    <button class="btn btn-primary btn-small" onclick="showActionModal('${cve.cve_id}')">
                                        Process
                                    </button>
                                ` : `
                                    <button class="btn btn-secondary btn-small" disabled>
                                        Processed
                                    </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function updatePagination(pagination) {
            const hasMore = pagination.has_more;
            const total = pagination.total;
            const offset = currentFilters.offset;
            const limit = currentFilters.limit;
            
            document.getElementById('prev-btn').disabled = offset === 0;
            document.getElementById('next-btn').disabled = !hasMore;
            
            const start = offset + 1;
            const end = Math.min(offset + limit, total);
            
            document.getElementById('pagination-info').textContent = 
                `Showing ${start}-${end} of ${total} CVEs`;
        }

        function updateFooter(total) {
            const pending = document.getElementById('pending-cves').textContent;
            document.getElementById('footer-info').innerHTML = `
                Showing <strong>${Math.min(currentFilters.limit, total)}</strong> CVEs ‚Ä¢ 
                <span class="status-badge status-pending">${pending} pending</span>
            `;
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
        }

        // Filter Functions
        function applyFilters() {
            currentFilters = {
                status: document.getElementById('filter-status').value,
                severity: document.getElementById('filter-severity').value,
                vendor: document.getElementById('filter-vendor').value,
                product: document.getElementById('filter-product').value,
                limit: 50,
                offset: 0
            };
            
            loadCVEs();
        }

        function clearFilters() {
            document.getElementById('filter-status').value = 'PENDING';
            document.getElementById('filter-severity').value = '';
            document.getElementById('filter-vendor').value = '';
            document.getElementById('filter-product').value = '';
            
            applyFilters();
        }

        function nextPage() {
            currentFilters.offset += currentFilters.limit;
            loadCVEs();
        }

        function prevPage() {
            currentFilters.offset = Math.max(0, currentFilters.offset - currentFilters.limit);
            loadCVEs();
        }

        // Action Functions
        function showActionModal(cveId) {
            currentCVEId = cveId;
            document.getElementById('action-modal-title').textContent = `Process ${cveId}`;
            document.getElementById('action-modal').style.display = 'flex';
        }

        async function submitAction() {
            const action = document.getElementById('action-select').value;
            const comments = document.getElementById('action-comments').value;
            const priority = document.getElementById('action-priority').value;
            
            const token = localStorage.getItem('ctba_token');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/cves/${currentCVEId}/action`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: action,
                        analyst: currentUser.username,
                        comments: comments,
                        priority: priority
                    })
                });
                
                if (response.ok) {
                    closeModal('action-modal');
                    showNotification('success', `CVE ${currentCVEId} ${action.toLowerCase()} successfully`);
                    loadCVEs();
                    loadStats();
                } else {
                    throw new Error('Action failed');
                }
            } catch (error) {
                showNotification('error', 'Failed to process CVE');
            }
        }

        function showAddTechModal() {
            document.getElementById('add-tech-modal').style.display = 'flex';
        }

        async function submitTechnology() {
            const vendor = document.getElementById('tech-vendor').value;
            const product = document.getElementById('tech-product').value;
            const status = document.getElementById('tech-status').value;
            const reason = document.getElementById('tech-reason').value;
            
            const token = localStorage.getItem('ctba_token');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/technologies`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        vendor: vendor,
                        product: product,
                        status: status,
                        reason: reason,
                        added_by: currentUser.username
                    })
                });
                
                if (response.ok) {
                    closeModal('add-tech-modal');
                    showNotification('success', `Technology ${vendor}/${product} added as ${status}`);
                    
                    // Clear form
                    document.getElementById('tech-vendor').value = '';
                    document.getElementById('tech-product').value = '';
                    document.getElementById('tech-reason').value = '';
                    
                    // Reload CVEs to reflect blacklist changes
                    if (status === 'OUT_OF_SCOPE') {
                        loadCVEs();
                    }
                } else {
                    throw new Error('Add technology failed');
                }
            } catch (error) {
                showNotification('error', 'Failed to add technology');
            }
        }

        // Open the Add Technology modal prefilled for a specific vendor/product
        function openProductModal(vendor, product) {
            document.getElementById('tech-vendor').value = vendor || '';
            document.getElementById('tech-product').value = product || '';
            document.getElementById('tech-status').value = 'NORMAL';
            document.getElementById('tech-reason').value = '';
            document.getElementById('add-tech-modal').style.display = 'flex';
        }

        async function showCVEDetail(cveId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/cves/${cveId}`);
                if (response.ok) {
                    const cve = await response.json();
                    
                    let productsHtml = '';
                    if (cve.affected_products && cve.affected_products.length > 0) {
                        cve.affected_products.forEach(p => {
                            let techBadge = '';
                            if (p.tech_status) {
                                const techClass = `tech-${p.tech_status.toLowerCase().replace('_', '-')}`;
                                techBadge = `<span class="tech-badge ${techClass}">${p.tech_status}</span>`;
                            }
                            productsHtml += `
                                <div style="margin-bottom: 8px; padding: 8px; background: #f8fafc; border-radius: 4px;">
                                    <strong>Vendor:</strong> ${p.vendor}<br>
                                    <strong>Product:</strong> ${p.product}
                                    ${techBadge ? `<br><strong>Tech Status:</strong> ${techBadge}` : ''}
                                    ${p.confidence ? `<br><strong>Confidence:</strong> ${(p.confidence * 100).toFixed(0)}%` : ''}
                                </div>
                            `;
                        });
                    }
                    
                    document.getElementById('cve-modal-title').textContent = cve.cve_id;
                    document.getElementById('cve-detail-content').innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <div>
                                <strong>Description:</strong>
                                <p style="margin-top: 8px; padding: 12px; background: #f8fafc; border-radius: 4px;">
                                    ${cve.description || 'No description available'}
                                </p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <strong>Severity:</strong>
                                    <div style="margin-top: 4px;">
                                        <span class="severity-badge severity-${cve.severity.toLowerCase()}">
                                            ${cve.severity}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <strong>CVSS Score:</strong>
                                    <div style="margin-top: 4px; font-size: 18px; font-weight: 600; color: ${cve.cvss_score && cve.cvss_score >= 9.0 ? '#dc2626' : cve.cvss_score >= 7.0 ? '#ea580c' : cve.cvss_score >= 4.0 ? '#ca8a04' : '#16a34a'};">
                                        ${cve.cvss_score && cve.cvss_score > 0 ? cve.cvss_score : 'N/A'}
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">
                                        ${cve.cvss_version && cve.cvss_version !== 'N/A' ? `CVSS v${cve.cvss_version}` : ''}
                                    </div>
                                </div>
                                <div>
                                    <strong>Status:</strong>
                                    <div style="margin-top: 4px;">
                                        <span class="status-badge status-${cve.status.toLowerCase()}">
                                            ${cve.status}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <strong>Published:</strong>
                                    <div style="margin-top: 4px;">
                                        ${cve.published_date_formatted || cve.published_date || 'N/A'}
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <strong>Affected Products:</strong>
                                <div style="margin-top: 8px;">
                                    ${productsHtml || 'No products identified'}
                                </div>
                            </div>
                            
                            ${cve.decision_comments ? `
                                <div>
                                    <strong>Decision Comments:</strong>
                                    <p style="margin-top: 8px; padding: 12px; background: #f8fafc; border-radius: 4px;">
                                        ${cve.decision_comments}
                                    </p>
                                </div>
                            ` : ''}
                            
                            ${cve.analyst ? `
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <strong>Analyst:</strong>
                                        <div style="margin-top: 4px;">${cve.analyst}</div>
                                    </div>
                                    <div>
                                        <strong>Decision Date:</strong>
                                        <div style="margin-top: 4px;">${cve.decision_date || 'N/A'}</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    document.getElementById('cve-detail-modal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error loading CVE details:', error);
            }
        }

        // Utility Functions
      // Remplacer l'ancienne fonction
function calculateDaysAgo(dateString) {
    if (!dateString) return 'N/A';
    
    try {
        // Supposer que la date est en UTC
        const utcDate = new Date(dateString + 'Z'); // Ajouter Z pour UTC
        const now = new Date();
        
        // Appliquer le d√©calage France (UTC+1)
        const frOffset = 60; // +1 heure en minutes
        const localDate = new Date(utcDate.getTime() + frOffset * 60000);
        const localNow = new Date(now.getTime() + frOffset * 60000);
        
        const diffTime = Math.abs(localNow - localDate);
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) {
            // V√©rifier si c'est aujourd'hui en France
            const isToday = localDate.getDate() === localNow.getDate() &&
                           localDate.getMonth() === localNow.getMonth() &&
                           localDate.getFullYear() === localNow.getFullYear();
            return isToday ? 'Aujourd\'hui' : 'Hier';
        }
        if (diffDays === 1) return 'Il y a 1 jour';
        return `Il y a ${diffDays} jours (UTC+1)`;
    } catch (error) {
        r
        return 'N/A';
    }
    }


// Fonction pour formater la date en UTC+1
function formatLocalDate(dateString) {
    if (!dateString) return 'N/A';
    
    try {
        // Supposer UTC, convertir en UTC+1
        const utcDate = new Date(dateString + 'Z');
        const options = {
            timeZone: 'Europe/Paris',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        };
        
        return utcDate.toLocaleString('fr-FR', options);
    } catch (error) {
        return dateString;
    }
}

        function showNotification(type, message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            
            if (type === 'success') {
                notification.style.backgroundColor = '#10b981';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#ef4444';
            } else {
                notification.style.backgroundColor = '#3b82f6';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

       async function refreshLatestCVEs() {
    try {
        // Afficher l'indicateur de chargement
        showLoadingOverlay();
        
        // D√©clencher l'import IMM√âDIAT des CVEs r√©cents
        const importResponse = await fetch(`${API_BASE_URL}/api/import/test-now`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await importResponse.json();
        console.log('Import result:', result);
        
        if (result.success) {
            // Attendre 2 secondes pour que l'import soit compl√©t√©
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Recharger les statistiques et les CVEs
            await loadStats();
            await loadCVEs();
            
            showNotification('success', 
                `‚úÖ Imported ${result.imported} new CVEs from the last 2 hours!`);
        } else {
            showNotification('error', 
                `‚ùå Import failed: ${result.error || 'Unknown error'}`);
        }
        
    } catch (error) {
        console.error('Error refreshing latest CVEs:', error);
        showNotification('error', 'Failed to refresh latest CVEs: ' + error.message);
    } finally {
        hideLoadingOverlay();
    }
}

// Fonction d'indicateur de chargement am√©lior√©e
function showLoadingOverlay() {
    let overlay = document.getElementById('global-loading-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'global-loading-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
        `;
        
        overlay.innerHTML = `
            <div style="
                background: white;
                padding: 30px;
                border-radius: 12px;
                text-align: center;
                color: #1e293b;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                max-width: 400px;
                width: 90%;
            ">
                <div style="
                    border: 4px solid #f3f3f3;
                    border-top: 4px solid #3498db;
                    border-radius: 50%;
                    width: 60px;
                    height: 60px;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                "></div>
                <h3 style="margin-bottom: 10px;">üîÑ Fetching Latest CVEs</h3>
                <p style="color: #64748b; margin-bottom: 20px;">
                    Importing newest CVEs from NVD database...
                </p>
                <div id="loading-progress" style="
                    background: #e2e8f0;
                    height: 6px;
                    border-radius: 3px;
                    overflow: hidden;
                    margin-bottom: 15px;
                ">
                    <div id="loading-progress-bar" style="
                        background: linear-gradient(90deg, #667eea, #764ba2);
                        height: 100%;
                        width: 0%;
                        transition: width 0.3s;
                    "></div>
                </div>
                <p id="loading-status" style="font-size: 14px; color: #64748b;">
                    Connecting to NVD...
                </p>
            </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Animation de la barre de progression
        let progress = 0;
        const progressBar = document.getElementById('loading-progress-bar');
        const statusText = document.getElementById('loading-status');
        const interval = setInterval(() => {
            progress += 2;
            if (progress <= 90) {
                progressBar.style.width = progress + '%';
                
                // Mettre √† jour le texte de statut
                if (progress < 30) {
                    statusText.textContent = 'Connecting to NVD API...';
                } else if (progress < 60) {
                    statusText.textContent = 'Fetching latest vulnerabilities...';
                } else {
                    statusText.textContent = 'Processing and importing CVEs...';
                }
            }
        }, 100);
        
        // Stocker l'intervalle pour le nettoyer plus tard
        overlay.dataset.interval = interval;
    }
}

function hideLoadingOverlay() {
    const overlay = document.getElementById('global-loading-overlay');
    if (overlay) {
        // Nettoyer l'intervalle
        if (overlay.dataset.interval) {
            clearInterval(overlay.dataset.interval);
        }
        
        // Animation de sortie
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity 0.3s';
        
        setTimeout(() => {
            if (overlay.parentNode) {
                overlay.parentNode.removeChild(overlay);
            }
        }, 300);
    }
}
      function refreshData() {
    loadStats();
    loadCVEs();
    showNotification('info', 'Data refreshed from database');
}

        function quickAction(action) {
            switch(action) {
                case 'review':
                    document.getElementById('filter-status').value = 'PENDING';
                    applyFilters();
                    break;
                case 'generate':
                    showNotification('info', 'Bulletin generation coming soon');
                    break;
                case 'blacklist':
                    showAddTechModal();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
            }
        }

        // Navigation Functions
        async function loadCVEManagement() {
            document.getElementById('dashboard-content').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 16px;">Loading CVE Management...</div>
                </div>
            `;

            // Ensure user is authenticated before showing management UI
            const ok = await checkAuth();
            if (!ok) return; // checkAuth will show login modal if needed

            // Reuse the main dashboard CVE view for management (shows filters, table, actions)
            loadDashboard();
            showNotification('info', 'CVE Management loaded');
        }

        function loadBulletins() {
            document.getElementById('dashboard-content').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 16px;">Loading Bulletins...</div>
                </div>
            `;
            showNotification('info', 'Bulletins page coming soon');
        }

        function loadAnalytics() {
            document.getElementById('dashboard-content').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 16px;">Loading Analytics...</div>
                </div>
            `;
            showNotification('info', 'Analytics page coming soon');
        }

        function loadTechnologies() {
            document.getElementById('dashboard-content').innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Technologies & Blacklist Management</div>
                        <button class="btn btn-primary" onclick="showAddTechModal()">
                            <i class="fas fa-plus"></i>
                            Add Technology
                        </button>
                    </div>
                    <div id="technologies-content">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <div style="margin-top: 16px;">Loading technologies...</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load technologies
            setTimeout(() => loadTechnologiesList(), 100);
        }

        async function loadTechnologiesList() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/technologies`);
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.technologies.length > 0) {
                        let html = `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Vendor</th>
                                            <th>Product</th>
                                            <th>Status</th>
                                            <th>Reason</th>
                                            <th>Added By</th>
                                            <th>Date Added</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        data.technologies.forEach(tech => {
                            const statusClass = `tech-${tech.status.toLowerCase().replace('_', '-')}`;
                            html += `
                                <tr>
                                    <td>${tech.vendor}</td>
                                    <td>${tech.product}</td>
                                    <td><span class="tech-badge ${statusClass}">${tech.status}</span></td>
                                    <td>${tech.reason || '-'}</td>
                                    <td>${tech.added_by}</td>
                                    <td>${new Date(tech.created_at).toLocaleDateString()}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-secondary btn-small">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-secondary btn-small" style="background: #fee2e2; color: #dc2626;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });
                        
                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                        
                        document.getElementById('technologies-content').innerHTML = html;
                    } else {
                        document.getElementById('technologies-content').innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                <i class="fas fa-inbox"></i> No technologies added yet
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading technologies:', error);
            }
        }

        function loadSettings() {
            document.getElementById('dashboard-content').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 16px;">Loading Settings...</div>
                </div>
            `;
            showNotification('info', 'Settings page coming soon');
        }

        function toggleUserMenu() {
            const menu = document.createElement('div');
            menu.style.cssText = `
                position: absolute;
                top: 60px;
                right: 24px;
                background: white;
                border: 1px solid var(--border-color);
                border-radius: var(--radius);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                min-width: 200px;
            `;
            
            menu.innerHTML = `
                <div style="padding: 12px 16px; border-bottom: 1px solid var(--border-color);">
                    <div style="font-weight: 600;">${currentUser.username}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">${currentUser.role}</div>
                </div>
                <div style="padding: 8px 0;">
                    <div style="padding: 8px 16px; cursor: pointer; color: var(--text-primary);" 
                         onmouseover="this.style.background='#f8fafc'" 
                         onmouseout="this.style.background='transparent'"
                         onclick="showNotification('info', 'Profile coming soon')">
                        <i class="fas fa-user" style="width: 20px;"></i> Profile
                    </div>
                    <div style="padding: 8px 16px; cursor: pointer; color: var(--text-primary);" 
                         onmouseover="this.style.background='#f8fafc'" 
                         onmouseout="this.style.background='transparent'"
                         onclick="showNotification('info', 'Settings coming soon')">
                        <i class="fas fa-cog" style="width: 20px;"></i> Settings
                    </div>
                    <div style="padding: 8px 16px; cursor: pointer; color: #ef4444;" 
                         onmouseover="this.style.background='#fef2f2'" 
                         onmouseout="this.style.background='transparent'"
                         onclick="logout()">
                        <i class="fas fa-sign-out-alt" style="width: 20px;"></i> Logout
                    </div>
                </div>
            `;
            
            document.body.appendChild(menu);
            
            // Close menu when clicking outside
            const closeMenu = (e) => {
                if (!menu.contains(e.target) && !document.querySelector('.user-profile').contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 10);
        }

        function logout() {
            localStorage.removeItem('ctba_token');
            localStorage.removeItem('ctba_user');
            currentUser = null;
            showLoginModal();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user is already logged in
            const token = localStorage.getItem('ctba_token');
            const user = localStorage.getItem('ctba_user');
            
            if (token && user) {
                currentUser = JSON.parse(user);
                updateUserDisplay();
                loadDashboard();
            } else {
                showLoginModal();
            }
            
            // Add global search handler
            document.getElementById('global-search').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    const searchTerm = e.target.value;
                    if (searchTerm) {
                        // Simple search - you can enhance this
                        document.getElementById('filter-vendor').value = searchTerm;
                        applyFilters();
                    }
                }
            });
            
            // Add CSS for animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
                textarea {
                    padding: 10px 12px;
                    border: 1px solid var(--border-color);
                    border-radius: 6px;
                    font-size: 14px;
                    font-family: 'Inter', sans-serif;
                    background: var(--card-bg);
                    color: var(--text-primary);
                    resize: vertical;
                }
                textarea:focus {
                    outline: none;
                    border-color: var(--primary-color);
                    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>